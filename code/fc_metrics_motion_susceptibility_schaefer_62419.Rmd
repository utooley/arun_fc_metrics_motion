---
title: "FC Metrics Susceptibility to Motion- Schaefer ICA Fix Only"
output:
  html_document:
    theme: united
    toc: yes
    toc_depth: 6
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(psych)
library(gam)
library(summarytools)
library(PerformanceAnalytics)
library(ppcor)
library(reshape2)
```

# All runs averaged together

```{r load data, include=FALSE}
data_dir="~/Documents/projects/in_progress/arun_fc_metrics_motion/"
dropbox_data="~/Dropbox/projects/in_progress/arun_fc_metrics_motion/output/data/Schaefer100_ICA_FIX/"
run1_data=read.csv(paste0(dropbox_data, "modularity_raw_REST1_LR_062419.csv"))
run2_data=read.csv(paste0(dropbox_data, "modularity_raw_REST1_RL_062419.csv"))
run3_data=read.csv(paste0(dropbox_data, "modularity_raw_REST2_LR_062419.csv"))
run4_data=read.csv(paste0(dropbox_data, "modularity_raw_REST2_RL_062419.csv"))
subject_list=read.csv(paste0(data_dir, "data/subjLists/S1200_Release_Subjects_Demographics.csv"))
subject_list <- subject_list %>% dplyr::select(.,Subject:Age) %>% rename(., subject=Subject)
```

## Do partial correlations for each run and average them together

```{r load data, include=FALSE}
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST1_LR/"
motiondata1 <- read.csv(paste0(mydir,"/rfMRI_REST1_LR.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data1 <- data.frame(subject_list, run1_data)
alldata1 <- merge(modul_data1, motiondata1, by = "subject", all = TRUE)
alldata1 <- alldata1 %>% filter(., num_communities_Pearson != 0)
#recode age to be the median of the bins that are provided
alldata1$Age_numeric <- dplyr::recode(alldata1$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=36)
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST1_RL/"
motiondata2 <- read.csv(paste0(mydir,"/rfMRI_REST1_RL.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data2 <- data.frame(subject_list, run2_data)
alldata2 <- merge(modul_data2, motiondata2, by = "subject", all = TRUE)
alldata2 <- alldata2 %>% filter(., num_communities_Pearson != 0)
#recode age to be the median of the bins that are provided
alldata2$Age_numeric <- dplyr::recode(alldata2$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=36)
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST2_LR/"
motiondata3 <- read.csv(paste0(mydir,"/rfMRI_REST2_LR.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data3 <- data.frame(subject_list, run3_data)
alldata3 <- merge(modul_data3, motiondata3, by = "subject", all = TRUE)
alldata3 <- alldata3 %>% filter(., num_communities_Pearson != 0)
alldata3 <- na.omit(alldata3)
#recode age to be the median of the bins that are provided
alldata3$Age_numeric <- dplyr::recode(alldata3$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=36)
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST2_RL/"
motiondata4 <- read.csv(paste0(mydir,"/rfMRI_REST2_RL.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data4 <- data.frame(subject_list, run4_data)
alldata4 <- merge(modul_data4, motiondata4, by = "subject", all = TRUE)
alldata4 <- alldata4 %>% filter(., num_communities_Pearson != 0)
alldata4 <- na.omit(alldata4)
#recode age to be the median of the bins that are provided
alldata4$Age_numeric <- dplyr::recode(alldata4$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=36)
```

## Raw modularity and motion correlations

```{r modularity motion, echo=TRUE}

#calculate the relationship between raw modularity and motion for each of the 4 runs
for (i in 1:4){
  assign("data",get(paste0("alldata",i)))
  rawcorr_modul<- lapply(data[12:17], function(eachFormula) {cor.test(eachFormula, data$motion, method="kendall")})
  rawcorr_modul_estimate<- lapply(data[12:17], function(eachFormula) {cor.test(eachFormula, data$motion, method="kendall")$estimate})
  motionavgweight_corr_estimate <- lapply(data[6:11], function(eachFormula) {cor.test(eachFormula, data$motion, method="kendall")$estimate})
  rawmotionmodul_corr <- data.frame(names(data)[12:17], unlist(rawcorr_modul_estimate))
  motionavgweight_corr <- data.frame(names(data)[6:11], unlist(motionavgweight_corr_estimate))
  assign(paste0("rawmotioncorr_tauestimate_run",i),rawmotionmodul_corr)
  assign(paste0("motionavgweight_corr_run",i),motionavgweight_corr)
}
#average them together
averaged_rawmotioncorr_acrossruns$estimate <-(rawmotioncorr_tauestimate_run1$unlist.rawcorr_modul_estimate.+rawmotioncorr_tauestimate_run2$unlist.rawcorr_modul_estimate.+rawmotioncorr_tauestimate_run3$unlist.rawcorr_modul_estimate.+rawmotioncorr_tauestimate_run4$unlist.rawcorr_modul_estimate.)/4
averaged_rawmotioncorr_acrossruns$names <- unlist(strsplit(names(alldata1)[12:17], "_"))[2*(1:length(names(alldata1[,12:17])))]

barplot(averaged_rawmotioncorr_acrossruns$estimate, names.arg =averaged_rawmotioncorr_acrossruns$names, ylim=c(0, -0.12), col="blue", cex.axis=1.5, cex.names=1)

```

## Modularity and motion, controlling for avg weight
```{r controlling for avgweight modul, echo=TRUE}
metrics=c("Pearson", "Spearman", "Coherence", "WaveletCoherence", "MutualInformation","MutualInformationTime")
#calculate the relationship between modularity and motion controlling for avg weight for each of 4 runs
alldata1 <- alldata1 %>% dplyr::select(.,-contains("num_communities")) %>% dplyr::select(.,-contains("allgamma"))
alldata2 <- alldata2 %>% dplyr::select(.,-contains("num_communities")) %>% dplyr::select(.,-contains("allgamma"))
alldata3 <- alldata3 %>% dplyr::select(.,-contains("num_communities")) %>% dplyr::select(.,-contains("allgamma"))
alldata4 <- alldata4 %>% dplyr::select(.,-contains("num_communities")) %>% dplyr::select(.,-contains("allgamma"))
for (i in 1:4){
  assign("data",get(paste0("alldata",i)))
  pcorr_modul_estimate=numeric(6)
  for (l in 1:6){
    assign("metric", metrics[l])
    temp <- data %>% dplyr::select(.,matches(paste0("_",metric,"$")),matches("motion"))
    print(colnames(temp))
    pcorr_modul_estimate[l] <- as.numeric(pcor.test(temp[2], temp[3], temp[1], method="kendall")$estimate)
  }
  assign(paste0("pcorr_modul_estimate_run",i),as.data.frame(pcorr_modul_estimate))
}
#average them together
averaged_pcormotion_acrossruns <-(pcorr_modul_estimate_run1$pcorr_modul_estimate+pcorr_modul_estimate_run2$pcorr_modul_estimate+pcorr_modul_estimate_run3$pcorr_modul_estimate+pcorr_modul_estimate_run4$pcorr_modul_estimate)/4
averaged_pcormotion_acrossruns <- as.data.frame(averaged_pcormotion_acrossruns)
averaged_pcormotion_acrossruns$names <- metrics

barplot(averaged_pcormotion_acrossruns$averaged_pcormotion_acrossruns, names.arg =averaged_pcormotion_acrossruns$names, ylim=c(0.01, -0.12), col="purple", cex.axis=1.5, cex.names=1)
```

## Modularity and motion, controlling for age and motion
```{r controlling for avgweight and covariates modul, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
for (i in 1:4){
  assign("data",get(paste0("alldata",i)))
  pcorr_modul_estimate=numeric(6)
  for (l in 1:6){
    assign("metric", metrics[l])
    temp <- data %>% dplyr::select(.,matches(paste0("_",metric,"$")),matches("motion"), matches("Age_numeric"),matches("Gender"))
    print(colnames(temp))
    temp2 <- cbind(temp$Age_numeric, temp[1])
    pcorr_modul_estimate[l] <- as.numeric(pcor.test(temp[2], temp[3], temp2, method = "kendall")$estimate)
  }
  assign(paste0("pcorr_modul_estimate_run",i),as.data.frame(pcorr_modul_estimate))
}
#average them together
averaged_pcormotion_allcovariates_acrossruns <-(pcorr_modul_estimate_run1$pcorr_modul_estimate+pcorr_modul_estimate_run2$pcorr_modul_estimate+pcorr_modul_estimate_run3$pcorr_modul_estimate+pcorr_modul_estimate_run4$pcorr_modul_estimate)/4
averaged_pcormotion_allcovariates_acrossruns <- as.data.frame(averaged_pcormotion_allcovariates_acrossruns)
averaged_pcormotion_allcovariates_acrossruns$names <- metrics

barplot(averaged_pcormotion_allcovariates_acrossruns$averaged_pcormotion_allcovariates_acrossruns, names.arg =averaged_pcormotion_allcovariates_acrossruns$names, ylim=c(0.01, -0.12), col="darkblue", cex.axis=1.5, cex.names=1)

```

# Run 1

```{r load data, include=FALSE}
data_dir="~/Documents/projects/in_progress/arun_fc_metrics_motion/"

runs=c("REST1_LR", "REST1_RL")
metrics=c("Pearson", "Spearman", "Coherence", "WaveletCoherence", "MutualInformation","MutualInformationTime")
run1_data=read.csv(paste0(dropbox_data, "modularity_raw_REST1_LR_062419.csv"))
subject_list=read.csv(paste0(data_dir, "data/subjLists/S1200_Release_Subjects_Demographics.csv"))
subject_list <- subject_list %>% dplyr::select(.,Subject:Age) %>% rename(., subject=Subject)
```


```{r clean data, include=FALSE}
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST1_LR/"
motiondata <- read.csv(paste0(mydir,"/rfMRI_REST1_LR.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data <- data.frame(subject_list, run1_data)
alldata <- merge(modul_data, motiondata, by = "subject", all = TRUE)
alldata <- alldata %>% filter(., num_communities_Pearson != 0)
#recode age to be the median of the bins that are provided
alldata$Age_numeric <- dplyr::recode(alldata$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=38)
dim(alldata)
```
Check dim for number of subjects here, to see if it is the same as that that Arun has for each of the 4 runs.

```{r summary, echo=TRUE}
#summary(alldata)
```

## Avg weight and motion

```{r avgweight motion, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the average weight and motion
par(mfrow=c(2,3))

myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=16,xlab="Motion",ylab=names(alldata)[index])
       }
lapply(6:11,FUN=myPlot)
#calculate the correlation between average weight and motion
formulaeAsText <- paste(names(alldata)[6:11], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_avgweight<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_avgweight_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotioncorr <- data.frame(names(alldata)[6:11], unlist(rawcorr_avgweight_sigmotion))
rawmotioncorr
```
## Raw modularity and motion

```{r modularity motion, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the raw modularity metrics calculated when tuning for 7 communities and motion
par(mfrow=c(2,3))

myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=19,xlab="Motion", col= "blue",ylab=names(alldata)[index])
       }
lapply(12:17,FUN=myPlot)

#calculate the relationship between raw modularity and motion
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotionmodul_corr <- data.frame(names(alldata)[12:17], unlist(rawcorr_modul_sigmotion))
rawmotionmodul_corr
```

## Modularity and motion, controlling for avg weight
```{r controlling for avgweight modul, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr <- data.frame(names(alldata)[12:17], unlist(corr_modul_sigmotion))
motionmodul_corr
```

## Modularity and motion, controlling for all covariates
```{r controlling for avgweight and covariates modul, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary_modul_sigmotion))
motionmodul_corr_covary
```

## Is this affected by differences in number of communities detected across subjects and metrics?

Are the number of communities correlated with motion? And then, does the same pattern of sig relationships present if controlling for number of communities detected for each subject?
```{r number of communities found per subject, echo=TRUE}
#calculate the relationship between motion and number of communities detected
formulaeAsText <- paste(names(alldata)[18:23], " ~ motion + avgweight_",unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_numcomms<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_numcomms_sigmotion<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
numcomms_corr <- data.frame(names(alldata)[12:17], unlist(corr_numcomms_sigmotion))
numcomms_corr

#calculate the relationship between modularity and motion also controlling for the number of communities found for each subject
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], "+ num_communities_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary2_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary2_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr2_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary2_modul_sigmotion))
motionmodul_corr2_covary
```

# Run 2
```{r load data 2, include=FALSE}
data_dir="~/Documents/projects/in_progress/arun_fc_metrics_motion/"
dropbox_data="~/Dropbox/projects/in_progress/arun_fc_metrics_motion/output/data/Schaefer100_ICA_FIX/"
run1_data=read.csv(paste0(dropbox_data, "modularity_raw_REST1_RL_062419.csv"))
subject_list=read.csv(paste0(data_dir, "data/subjLists/S1200_Release_Subjects_Demographics.csv"))
subject_list <- subject_list %>% dplyr::select(.,Subject:Age) %>% rename(., subject=Subject)
```

```{r clean data 2, include=FALSE}
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST1_RL/"
motiondata <- read.csv(paste0(mydir,"/rfMRI_REST1_RL.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data <- data.frame(subject_list, run1_data)
alldata <- merge(modul_data, motiondata, by = "subject", all = TRUE)
alldata <- alldata %>% filter(., num_communities_Pearson != 0)
#recode age to be the median of the bins that are provided
alldata$Age_numeric <- dplyr::recode(alldata$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=38)
dim(alldata)
```
## Avg weight and motion

```{r avgweight motion 2, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the average weight and motion
par(mfrow=c(2,3))

myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=16,xlab="Motion",ylab=names(alldata)[index])
       }
lapply(6:11,FUN=myPlot)
#calculate the correlation between average weight and motion
formulaeAsText <- paste(names(alldata)[6:11], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_avgweight<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_avgweight_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotioncorr <- data.frame(names(alldata)[6:11], unlist(rawcorr_avgweight_sigmotion))
rawmotioncorr
```
## Raw modularity and motion

```{r modularity motion 2, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the raw modularity metrics calculated when tuning for 7 communities and motion
par(mfrow=c(2,3))
myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=19,xlab="Motion", col= "blue",ylab=names(alldata)[index])
       }
lapply(12:17,FUN=myPlot)

#calculate the relationship between raw modularity and motion
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotionmodul_corr <- data.frame(names(alldata)[12:17], unlist(rawcorr_modul_sigmotion))
rawmotionmodul_corr
```

## Modularity and motion, controlling for avg weight
```{r controlling for avgweight modul 2, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr <- data.frame(names(alldata)[12:17], unlist(corr_modul_sigmotion))
motionmodul_corr
```

## Modularity and motion, controlling for all covariates
```{r controlling for avgweight and covariates modul 2, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary_modul_sigmotion))
motionmodul_corr_covary
```

## Is this affected by differences in number of communities detected across subjects and metrics?
Are the number of communities correlated with motion? And then, does the same pattern of sig relationships present if controlling for number of communities detected for each subject?
```{r number of communities found per subject 2, echo=TRUE}
#calculate the relationship between motion and number of communities detected
formulaeAsText <- paste(names(alldata)[18:23], " ~ motion + avgweight_",unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_numcomms<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_numcomms_sigmotion<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
numcomms_corr <- data.frame(names(alldata)[12:17], unlist(corr_numcomms_sigmotion))
numcomms_corr

#calculate the relationship between modularity and motion also controlling for the number of communities found for each subject
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], "+ num_communities_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary2_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary2_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr2_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary2_modul_sigmotion))
motionmodul_corr2_covary
```
# Run 3

```{r load data 3, include=FALSE}
run1_data=read.csv(paste0(dropbox_data, "modularity_raw_REST2_LR_062419.csv"))
subject_list=read.csv(paste0(data_dir, "data/subjLists/S1200_Release_Subjects_Demographics.csv"))
subject_list <- subject_list %>% dplyr::select(.,Subject:Age) %>% rename(., subject=Subject)
```

```{r clean data 3, include=FALSE}
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST2_LR/"
motiondata <- read.csv(paste0(mydir,"/rfMRI_REST2_LR.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data <- data.frame(subject_list, run1_data)
alldata <- merge(modul_data, motiondata, by = "subject", all = TRUE)
alldata <- alldata %>% filter(., num_communities_Pearson != 0)
#recode age to be the median of the bins that are provided
alldata$Age_numeric <- dplyr::recode(alldata$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=38)
dim(alldata)
```
## Avg weight and motion

```{r avgweight and motion 3, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the average weight and motion
par(mfrow=c(2,3))

myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=16,xlab="Motion",ylab=names(alldata)[index])
       }
lapply(6:11,FUN=myPlot)
#calculate the correlation between average weight and motion
formulaeAsText <- paste(names(alldata)[6:11], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_avgweight<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_avgweight_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotioncorr <- data.frame(names(alldata)[6:11], unlist(rawcorr_avgweight_sigmotion))
rawmotioncorr
```
## Raw modularity and motion

```{r modularity and motion 3, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the raw modularity metrics calculated when tuning for 7 communities and motion
par(mfrow=c(2,3))
myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=19,xlab="Motion", col= "blue",ylab=names(alldata)[index])
       }
lapply(12:17,FUN=myPlot)

#calculate the relationship between raw modularity and motion
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotionmodul_corr <- data.frame(names(alldata)[12:17], unlist(rawcorr_modul_sigmotion))
rawmotionmodul_corr
```

## Modularity and motion, controlling for avg weight
```{r controlling for avgweight modul 3, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr <- data.frame(names(alldata)[12:17], unlist(corr_modul_sigmotion))
motionmodul_corr
```

## Modularity and motion, controlling for all covariates
```{r controlling for avgweight and covariates modul 3, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary_modul_sigmotion))
motionmodul_corr_covary
```

## Is this affected by differences in number of communities detected across subjects and metrics?
Are the number of communities correlated with motion? And then, does the same pattern of sig relationships present if controlling for number of communities detected for each subject?
```{r number of communities found per subject 3, echo=TRUE}
#calculate the relationship between motion and number of communities detected
formulaeAsText <- paste(names(alldata)[18:23], " ~ motion + avgweight_",unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_numcomms<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_numcomms_sigmotion<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
numcomms_corr <- data.frame(names(alldata)[12:17], unlist(corr_numcomms_sigmotion))
numcomms_corr

#calculate the relationship between modularity and motion also controlling for the number of communities found for each subject
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], "+ num_communities_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary2_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary2_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr2_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary2_modul_sigmotion))
motionmodul_corr2_covary
```

# Run 4
```{r load data 4, include=FALSE}
run1_data=read.csv(paste0(dropbox_data, "modularity_raw_REST2_RL_062419.csv"))
subject_list=read.csv(paste0(data_dir, "data/subjLists/S1200_Release_Subjects_Demographics.csv"))
subject_list <- subject_list %>% dplyr::select(.,Subject:Age) %>% rename(., subject=Subject)
```

```{r clean data 4, include=FALSE}
mydir="~/Documents/projects/in_progress/arun_fc_metrics_motion/data/subjData/Motion_S1200/rfMRI_REST2_RL/"
motiondata <- read.csv(paste0(mydir,"/rfMRI_REST2_RL.csv"), header = FALSE, col.names = c("subject", "motion"))
modul_data <- data.frame(subject_list, run1_data)
alldata <- merge(modul_data, motiondata, by = "subject", all = TRUE)
alldata <- alldata %>% filter(., num_communities_Pearson != 0)
#recode age to be the median of the bins that are provided
alldata$Age_numeric <- dplyr::recode(alldata$Age, "22-25"= 23.5, "26-30"=28, "31-35"=33, "36+"=38)
dim(alldata)
```
## Avg weight and motion

```{r avgweight and motion 4, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the average weight and motion
par(mfrow=c(2,3))

myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=16,xlab="Motion",ylab=names(alldata)[index])
       }
lapply(6:11,FUN=myPlot)
#calculate the correlation between average weight and motion
formulaeAsText <- paste(names(alldata)[6:11], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_avgweight<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_avgweight_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotioncorr <- data.frame(names(alldata)[6:11], unlist(rawcorr_avgweight_sigmotion))
rawmotioncorr
```
## Raw modularity and motion

```{r modularity and motion, echo=TRUE}
#For each of the 6 metrics, plot the correlation between the raw modularity metrics calculated when tuning for 7 communities and motion
par(mfrow=c(2,3))
myPlot<-function(index) {
  plot(alldata[,index] ~ alldata$motion, main=names(alldata[index]),pch=19,xlab="Motion", col= "blue",ylab=names(alldata)[index])
       }
lapply(12:17,FUN=myPlot)

#calculate the relationship between raw modularity and motion
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion", sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
rawcorr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
rawcorr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
rawmotionmodul_corr <- data.frame(names(alldata)[12:17], unlist(rawcorr_modul_sigmotion))
rawmotionmodul_corr
```

## Modularity and motion, controlling for avg weight
```{r controlling for avgweight modul 4, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr <- data.frame(names(alldata)[12:17], unlist(corr_modul_sigmotion))
motionmodul_corr
```

## Modularity and motion, controlling for all covariates
```{r controlling for avgweight and covariates modul 4, echo=TRUE}
#calculate the relationship between modularity and motion controlling for avg weight
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary_modul_sigmotion))
motionmodul_corr_covary
```

## Is this affected by differences in number of communities detected across subjects and metrics?
Are the number of communities correlated with motion? And then, does the same pattern of sig relationships present if controlling for number of communities detected for each subject?
```{r number of communities found per subject 4, echo=TRUE}
#calculate the relationship between motion and number of communities detected
formulaeAsText <- paste(names(alldata)[18:23], " ~ motion + avgweight_",unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_numcomms<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_numcomms_sigmotion<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
numcomms_corr <- data.frame(names(alldata)[12:17], unlist(corr_numcomms_sigmotion))

#calculate the relationship between modularity and motion also controlling for the number of communities found for each subject
formulaeAsText <- paste(names(alldata)[12:17], " ~ motion + Age_numeric + Gender + avgweight_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], "+ num_communities_", unlist(strsplit(names(alldata)[12:17], "_"))[2*(1:length(names(alldata[,12:17])))], sep="")
formulae <- lapply(formulaeAsText,FUN=formula)
corr_covary2_modul<- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))})
corr_covary2_modul_sigmotion <- lapply(formulae, function(eachFormula) {summary(lm(eachFormula,data=alldata))$coefficients[2,4]})
motionmodul_corr2_covary <- data.frame(names(alldata)[12:17], unlist(corr_covary2_modul_sigmotion))
motionmodul_corr2_covary
```